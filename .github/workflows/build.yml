name: Project Build
run-name: "ğŸ“¦ Project Build #${{ github.run_number }}"
on:
  push:
    branches:
      - dev
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DEV_ENVIRONMENT: ${{ github.ref_name != 'main' }}

jobs:    
  info:
    name: ğŸ–¥ï¸ Project Info
    runs-on: ubuntu-latest
    outputs:
      project_version: ${{ steps.check.outputs.project_version }}
      project_name: ${{ steps.check.outputs.project_name }}
      project_full_name: ${{ steps.check.outputs.project_name }}-${{ steps.check.outputs.project_version }}
      changelog: ${{ steps.changelog.outputs.description }}
      mc_version: ${{ steps.check.outputs.minecraft_version }}
      loader_version: ${{ steps.check.outputs.loader_version }}
      loader_type: ${{ steps.check.outputs.loader_type }}
      release_type: ${{ steps.check.outputs.release_type }}
      diff: ${{ steps.read_diff.outputs.diff }}
      exists: ${{ steps.check_tag.outputs.exists }}
      make_release: ${{ steps.check.outputs.make_release }}
      make_pr: ${{ steps.check.outputs.make_pr }}
    
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0
        
      - name: ğŸ” Check pakku-lock.json
        id: check_pakku_lock
        shell: bash
        run: |
          if [ ! -f pakku-lock.json ]; then
            echo "âŒ Could not find pakku-lock.json" && exit 1
          else
            echo "âœ”ï¸ pakku-lock.json"
          fi
        
      - name: ğŸ” Check pakku.json
        id: check_pakku
        shell: bash
        run: |
          if [ ! -f pakku.json ]; then
            echo "âŒ Could not find pakku.json" && exit 1
          else
            echo "âœ”ï¸ pakku.json"
          fi

      - name: ğŸ“ˆ Get latest tag
        id: latest_tag
        shell: bash
        run: |
          tag=$(git describe --tags --abbrev=0 origin/main)
          if [ -z "$tag" ]; then
            echo "âŒ Latest tag not found" && exit 1
          else
            echo "âœ”ï¸ Latest tag found: $tag"
            echo "tag=$tag" >> $GITHUB_OUTPUT
          fi
        
      - name: ğŸ” Check pakku-lock.json in previous tag
        id: check_pakku_lock_prev
        shell: bash
        run: |
          if git cat-file -e ${{ steps.latest_tag.outputs.tag }}:./pakku-lock.json 2>/dev/null; then
            echo "âœ”ï¸ File pakku-lock.json found in previous tag"
            echo "file_found=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ File pakku-lock.json not found in previous tag"
            echo "file_found=false" >> $GITHUB_OUTPUT
          fi
        
      - name: ğŸ“ Check and copy pakku-lock.json from previous tag
        id: check_copy_lock
        if: steps.check_pakku_lock_prev.outputs.file_found == 'true'
        shell: bash
        run: |
          git show tags/${{ steps.latest_tag.outputs.tag }}:./pakku-lock.json > ./pakku-lock-prev.json
          if [ -s ./pakku-lock-prev.json ]; then
            echo "âœ”ï¸ File pakku-lock-prev.json created"
          else
            echo "âŒ Error: File pakku-lock-prev.json is empty or not created" && exit 1
          fi
        
      - name: ğŸ”„ Run pakku diff
        id: pakku_diff
        if: steps.check_pakku_lock_prev.outputs.file_found == 'true'
        shell: bash
        run: |
          java -jar pakku.jar diff -v --markdown PROJECTS_DIFF.md ./pakku-lock-prev.json ./pakku-lock.json
          if [ -f PROJECTS_DIFF.md ]; then
            echo "âœ”ï¸ Comparison completed"
          else
            echo "âŒ Error: File PROJECTS_DIFF.md not created" && exit 1
          fi
        
      - name: ğŸ“ Read PROJECTS_DIFF.md to variable
        id: read_diff
        if: steps.check_pakku_lock_prev.outputs.file_found == 'true'
        shell: bash
        run: |
          echo "ğŸ“ Reading PROJECTS_DIFF.md to variable..."
          {
            echo 'diff<<EOF'
            cat -v PROJECTS_DIFF.md
            echo EOF
          } >> "$GITHUB_OUTPUT"
          echo "âœ”ï¸ Diff content read to variable"

      - name: ğŸ“Š Get Pakku Info
        id: pakku_info
        uses: ActionsTools/read-json-action@v1.0.5
        with:
          file_path: "pakku.json"

      - name: ğŸ“Š Get Pakku-lock Info
        id: pakku_lock_info
        uses: ActionsTools/read-json-action@v1.0.5
        with:
          file_path: "pakku-lock.json"

      - name: ğŸ“„ Changelog Dev Parser
        id: changelog_dev
        if: ${{ env.DEV_ENVIRONMENT == 'true' }}
        uses: coditory/changelog-parser@v1.0.2
        with:
          path: CHANGELOG.md
          version: "unreleased"
        continue-on-error: true
        
      - name: ğŸ“„ Changelog Parser
        id: changelog
        uses: coditory/changelog-parser@v1.0.2
        with:
          path: CHANGELOG.md
        continue-on-error: true

      - name: ğŸ” Check if tag exists
        uses: mukunku/tag-exists-action@v1.7.0
        id: check_tag
        with:
          tag: ${{ steps.changelog.outputs.version }}

      - name: ğŸ” Check
        id: check
        shell: bash
        run: |
         
          MC_VERSIONS_JSON='${{ steps.pakku_lock_info.outputs.mc_versions }}'
          MINECRAFT_VERSION=$(echo "$MC_VERSIONS_JSON" | jq -r '.[0]' | tr -d '[]"')

          LOADERS_JSON='${{ steps.pakku_lock_info.outputs.loaders }}'

          LOADER_TYPE=$(echo "$LOADERS_JSON" | jq -r 'keys[0]')
          LOADER_VERSION=$(echo "$LOADERS_JSON" | jq -r ".[keys[0]]")

          echo "minecraft_version=$MINECRAFT_VERSION" >> $GITHUB_OUTPUT
          echo "loader_version=$LOADER_VERSION" >> $GITHUB_OUTPUT
          echo "loader_type=$LOADER_TYPE" >> $GITHUB_OUTPUT

          if ${{ env.DEV_ENVIRONMENT == 'true' }}; then
            echo "project_version=build_#${{ github.run_number }}" >> $GITHUB_OUTPUT
          else
            echo "project_version=${{ steps.changelog.outputs.version }}" >> $GITHUB_OUTPUT
          fi

          echo "project_name=${{ steps.pakku_info.outputs.name }}" >> $GITHUB_OUTPUT
          echo "release_type=${{ steps.pakku_info.outputs.release_type }}" >> $GITHUB_OUTPUT
          echo "make_release=${{ steps.check_tag.outputs.exists == 'false' && env.DEV_ENVIRONMENT == 'false' }}" >> $GITHUB_OUTPUT
          echo "make_pr=${{ steps.check_tag.outputs.exists == 'false' && env.DEV_ENVIRONMENT == 'true' }}" >> $GITHUB_OUTPUT

      - name: ğŸ“„ Format diff
        id: format_diff
        if: ${{ steps.read_diff.outputs.diff != '' }}
        uses: roamingowl/template-output-with-eta@v2.2.0
        with:
          template: |
            ```markdown
            ${{ steps.read_diff.outputs.diff }}
            ```

      - name: ğŸ“ Generate Github Summary
        uses: WcAServices/markdown-template-action@v1.1.1
        with:
          template: |
            ğŸ“ƒ **Name**: ${{ steps.check.outputs.project_name }}
            ğŸ“ƒ **Release**:  `${{ steps.check.outputs.project_version }}`
            ğŸ“ƒ **Release Type**: `${{ steps.check.outputs.release_type }}`
            ğŸ“ƒ **Game Version**: `${{ steps.check.outputs.minecraft_version }}`
            ğŸ“ƒ **Loader Type**: `${{ steps.check.outputs.loader_type }}`
            ğŸ“ƒ **Loader Version**: `${{ steps.check.outputs.loader_version }}`

            ğŸ“ƒ **Dev Environment**: `${{ env.DEV_ENVIRONMENT }}`
            ğŸ“ƒ **Tag Exists**: `${{ steps.check_tag.outputs.exists }}`
            ğŸ“ƒ **Make Pull Request**: `${{ steps.check.outputs.make_pr }}`
            ğŸ“ƒ **Make Release**: `${{ steps.check.outputs.make_release }}`
            

            ${{ steps.changelog_dev.outputs.description }}
            ${{ steps.format_diff.outputs.text }}
  
  create-pr:
    name: ğŸ¤ Create Release PR
    needs: [info]
    if: ${{ needs.info.outputs.make_pr == 'true' }}
    runs-on: ubuntu-latest
    steps:

      - name: Checkout
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0

      - name: ğŸ“„ Changelog Parser
        id: changelog
        uses: coditory/changelog-parser@v1.0.2
        with:
          path: CHANGELOG.md
        continue-on-error: true

      - name: ğŸ” Check existing PRs
        id: check_existing_pr
        uses: actions/github-script@v8.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          result-encoding: string
          script: |
            try {
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:dev`,
                base: 'main'
              });

              core.setOutput('exists', prs.length > 0);
              console.log(`â„¹ï¸ PR exists: ${prs.length > 0}`);
            } catch (error) {
              core.setFailed(`âŒ PR check failed: ${error}`);
              core.setOutput('exists', true);
            }

      - name: ğŸ” Check if milestone exists
        id: check_milestone
        uses: actions/github-script@v8.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          result-encoding: string
          script: |
            const version = '${{ steps.changelog.outputs.version }}';
            try {
              const milestones = await github.rest.issues.listMilestones({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all'
              });
              const milestoneExists = milestones.data.some(milestone => milestone.title === version);
              console.log(`Milestone "${version}" exists: ${milestoneExists}`);
              return milestoneExists;
            } catch (error) {
              console.log('Error checking milestones, assuming milestone does not exist');
              return false;
            }

      - name: ğŸ” Create Pull Request if tag not found
        if: ${{ steps.check_existing_pr.outputs.exists == 'false' }}
        uses: devops-infra/action-pull-request@v1.0.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          source_branch: dev
          target_branch: main
          milestone: ${{ steps.check_milestone.outputs.result == 'true' && steps.changelog.outputs.version || '' }}
          ignore_users: "dependabot"
          draft: true
          title: 'Release: ${{ steps.changelog.outputs.version }}'
          body: |
            **This is an automated Pull Request from the dev branch.**
            ğŸ“ƒ **Name**: ${{ needs.info.outputs.project_name }}
            ğŸ“ƒ **Release**:  `${{ steps.changelog.outputs.version }}`
            ğŸ“ƒ **Release Type**: `${{ needs.info.outputs.release_type }}`
            ğŸ“ƒ **Loader**: `${{ needs.info.outputs.loader_type }}-${{ needs.info.outputs.loader_version }}`

            ${{ needs.info.outputs.changelog }}

  build-all:
    name: ğŸ“¦ Build All Artifacts
    needs: [info]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: ğŸ”„ Replace strings
        shell: bash
        run: |
          VERSION=${{ needs.info.outputs.project_version }}
          LOADER_VERSION=${{ needs.info.outputs.loader_version }}
          LOADER_TYPE=${{ needs.info.outputs.loader_type }}
          MINECRAFT_VERSION=${{ needs.info.outputs.mc_version }}

          sed -i -e "s/DEV/${VERSION}/g" pakku.json
          sed -i -e "s/DEV/${VERSION}/g" config/mod-director/modpack.json
          sed -i -e "s/DEV/${VERSION}/g" config/fancymenu/customization/gui_main_menu.txt

      - name: ğŸ“ Cache pakku
        uses: actions/cache@v5.0.1
        id: cache
        with:
          path: build/.cache
          key: pakku-cache-${{ hashFiles('pakku-lock.json') }}
          restore-keys: pakku-cache-

      - name: ğŸ“¦ Export modpack
        run: |
          java -jar pakku.jar fetch
          java -jar pakku.jar export

      - name: ğŸ® Build Minecraft structure artifact
        run: |
          mkdir -p build/minecraft-structure/.minecraft
          
          cp -rf ./build/.cache/curseforge/overrides/* ./build/minecraft-structure/.minecraft/
          
          if [ -d "./mods" ]; then
            cp -rf ./mods/* ./build/minecraft-structure/.minecraft/mods/
          fi
          
          if [ -d "./resourcepacks" ]; then
            cp -rf ./resourcepacks ./build/minecraft-structure/.minecraft/
          fi
          
          if [ -d "./shaderpacks" ]; then
            cp -rf ./shaderpacks ./build/minecraft-structure/.minecraft/
          fi
          
          if [ -d "./config/fancymenu/assets/icons" ]; then
            cp -vf ./config/fancymenu/assets/icons/icon128x128.png ./build/minecraft-structure/.minecraft/icon.png
          fi
          
          mkdir -p ./build/minecraft-structure/.minecraft/saves
          mkdir -p ./build/minecraft-structure/.minecraft/logs
          
          cd ./build/minecraft-structure
          zip -r ${{ needs.info.outputs.project_full_name }}-minecraft.zip .minecraft/

      - name: ğŸš€ Upload Minecraft structure artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: ${{ needs.info.outputs.project_full_name }}-minecraft
          path: ./build/minecraft-structure/${{ needs.info.outputs.project_full_name }}-minecraft.zip
          if-no-files-found: error

      - name: ğŸ–¥ï¸ Build Server artifact
        run: |
          cd ./build/serverpack/
          mv *.zip $(basename -s .zip *.zip)-serverpack.zip

      - name: ğŸš€ Upload Server artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: ${{ needs.info.outputs.project_full_name }}-serverpack
          path: ./build/serverpack/${{ needs.info.outputs.project_full_name }}-serverpack.zip
          if-no-files-found: error

  release-github:
    name: ğŸš€ Release to GitHub
    needs: [info, build-all]
    runs-on: ubuntu-latest
    if: ${{ needs.info.outputs.make_release == 'true' }}
    outputs:
      url: ${{ steps.release.outputs.url }}

    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v6.0.1

      - name: ğŸ“¦ Download artifacts
        uses: actions/download-artifact@v7.0.0
        with:
          merge-multiple: true

      - name: ğŸ” Check if artifacts exist
        id: check_artifact
        shell: bash
        run: |
          if [ ! -f ${{ needs.info.outputs.project_full_name }}-serverpack.zip ]; then
            echo '::error::No value found for artifact `serverpack.zip`.' && exit 1
          fi
          if [ ! -f ${{ needs.info.outputs.project_full_name }}-minecraft.zip ]; then
            echo '::error::No value found for artifact `minecraft.zip`.' && exit 1
          fi
          echo "âœ”ï¸ All artifacts found"

      - name: ğŸ“„ Format diff
        id: format_diff
        if: ${{ needs.info.outputs.diff != '' }}
        uses: roamingowl/template-output-with-eta@v2.2.0
        with:
          template: |
            ```markdown
            ${{ needs.info.outputs.diff }}
            ```

      - name: ğŸš€ Create release
        id: release
        uses: softprops/action-gh-release@v2.5.0
        with:
          name: ${{ needs.info.outputs.project_version }}
          tag_name: ${{ needs.info.outputs.project_version }}
          target_commitish: ${{ github.ref_name }}
          body: |
            ${{ needs.info.outputs.changelog }}
            ${{ steps.format_diff.outputs.text }}
          files: |
            ${{ needs.info.outputs.project_full_name }}-serverpack.zip
            ${{ needs.info.outputs.project_full_name }}-minecraft.zip
          prerelease: ${{ needs.info.outputs.release_type != 'release' }}
          generate_release_notes: true
          token: ${{ secrets.GITHUB_TOKEN }}
